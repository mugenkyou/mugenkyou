name: Update Banner & Daily Activity

on:
  schedule:
    # Runs every 10 minutes
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  update-banner:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      # Install ImageMagick for image processing
      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      # Create assets directory if it doesn't exist
      - name: Create assets directory
        run: mkdir -p assets

      # Update header image based on time of day
      - name: Update header image based on time
        run: |
          export TZ="Asia/Kolkata"
          current_hour=$(date +%H)
          echo "Current hour in IST is $current_hour"
          
          # Store previous file hash if it exists
          if [ -f assets/dynamic-header.gif ]; then
            PREV_HASH=$(md5sum assets/dynamic-header.gif | cut -d' ' -f1)
            echo "Previous file hash: $PREV_HASH"
          else
            PREV_HASH=""
            echo "No previous dynamic-header.gif found"
          fi
          
          if (( current_hour >= 6 && current_hour < 18 )); then
            echo "It's daytime (6 AM - 6 PM). Using day.gif"
            # Copy day.gif to dynamic-header.gif for daytime
            if [ -f assets/day.gif ]; then
              cp assets/day.gif assets/dynamic-header.gif
            else
              echo "Error: assets/day.gif not found!"
              exit 1
            fi
          else
            echo "It's nighttime (6 PM - 6 AM). Using night.jpg"
            # Convert night.jpg to gif format for consistency
            if [ -f assets/night.jpg ]; then
              convert assets/night.jpg -resize 800x200 -gravity center -extent 800x200 assets/dynamic-header.gif
            else
              echo "Error: assets/night.jpg not found!"
              exit 1
            fi
          fi
          
          # Check if file actually changed
          if [ -f assets/dynamic-header.gif ]; then
            NEW_HASH=$(md5sum assets/dynamic-header.gif | cut -d' ' -f1)
            echo "New file hash: $NEW_HASH"
            if [ "$PREV_HASH" = "$NEW_HASH" ]; then
              echo "File content unchanged, no need to commit"
              echo "SKIP_COMMIT=true" >> $GITHUB_ENV
            else
              echo "File content changed, will commit"
              echo "SKIP_COMMIT=false" >> $GITHUB_ENV
            fi
          else
            echo "Failed to create dynamic-header.gif"
            exit 1
          fi

      # Commit and push the updated banner to main branch
      - name: Commit and push banner changes
        env:
          GH_REPO: ${{ github.repository }}
        run: |
          # Configure git
          git config user.name "mugenkyou"
          git config user.email "mugenkyou@users.noreply.github.com"
          
          # Check if we should skip commit
          if [ "$SKIP_COMMIT" = "true" ]; then
            echo "Skipping commit - no changes detected"
            exit 0
          fi
          
          # Add the updated banner
          git add assets/dynamic-header.gif
          
          # Check if there are actually staged changes
          if git diff --staged --quiet; then
            echo "No staged changes to commit"
          else
            # Get current time for commit message
            CURRENT_TIME=$(TZ="Asia/Kolkata" date '+%Y-%m-%d %H:%M:%S IST')
            COMMIT_MSG="ğŸ”„ Auto-update banner for $(TZ="Asia/Kolkata" date '+%H:%M IST') - $CURRENT_TIME"
            
            echo "Committing changes with message: $COMMIT_MSG"
            git commit -m "$COMMIT_MSG"
            
            # Push changes using GITHUB_TOKEN-provisioned remote
            git push origin HEAD:main
            echo "âœ… Changes pushed successfully!"
          fi

      - name: Success message
        run: |
          echo "âœ… Banner workflow completed successfully!"
          echo "ğŸ• Current time: $(TZ='Asia/Kolkata' date)"
          echo "ğŸ“ Banner saved to: assets/dynamic-header.gif"
          echo "ğŸŒ… Daytime: 6 AM - 6 PM (day.gif)"
          echo "ğŸŒ™ Nighttime: 6 PM - 6 AM (night.jpg converted to gif)"